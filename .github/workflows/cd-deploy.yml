name: Snowflake Native App CD

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    types: [closed]
    branches:
      - main
      - staging

concurrency:
  group: snowflake-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Snowflake
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PAT: ${{ secrets.SNOWFLAKE_PAT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set deploy environment
        run: |
          TARGET_BRANCH="${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}"
          if [[ "$TARGET_BRANCH" == "staging" ]]; then
            echo "DEPLOY_ENV=staging" >> "$GITHUB_ENV"
            echo "TARGET_DB=${{ vars.SNOWFLAKE_DATABASE_STAGING || 'NATIVE_OBS' }}" >> "$GITHUB_ENV"
            echo "TARGET_SCHEMA=${{ vars.SNOWFLAKE_SCHEMA_STAGING || 'PROD' }}" >> "$GITHUB_ENV"
          elif [[ "$TARGET_BRANCH" == "main" ]]; then
            echo "DEPLOY_ENV=prod" >> "$GITHUB_ENV"
            echo "TARGET_DB=${{ vars.SNOWFLAKE_DATABASE_PROD || 'NATIVE_OBS' }}" >> "$GITHUB_ENV"
            echo "TARGET_SCHEMA=${{ vars.SNOWFLAKE_SCHEMA_PROD || 'PROD' }}" >> "$GITHUB_ENV"
          else
            echo "Unexpected branch: $TARGET_BRANCH"
            exit 1
          fi

      - name: Install Snowflake CLI
        uses: snowflakedb/snowflake-cli-action@v1.5
        with:
          cli-version: latest

      - name: Configure Snowflake CLI connection
        run: |
          mkdir -p "$HOME/.snowflake"
          printf "%s" "${SNOWFLAKE_PAT}" > "$HOME/.snowflake/pat_token.txt"
          cat > "$HOME/.snowflake/config.toml" <<EOF
          default_connection_name = "OBSERVABILITYAPP"

          [connections.OBSERVABILITYAPP]
          account = "${SNOWFLAKE_ACCOUNT}"
          user = "${SNOWFLAKE_USER}"
          authenticator = "PROGRAMMATIC_ACCESS_TOKEN"
          token_file_path = "$HOME/.snowflake/pat_token.txt"
          EOF
          chmod 700 "$HOME/.snowflake"
          chmod 600 "$HOME/.snowflake/pat_token.txt"
          chmod 600 "$HOME/.snowflake/config.toml"

      - name: Validate Snowflake connection
        run: |
          snow --version
          snow connection test --connection OBSERVABILITYAPP

      - name: Deploy app scripts in order
        run: |
          snow sql -f native_app/setup.sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA"
          snow sql -f native_app/scripts/001_init.sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA"
          snow sql -f native_app/scripts/002_cortex_udfs.sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA"
          snow sql -f native_app/scripts/003_monitoring.sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA"
          snow sql -f native_app/scripts/004_remediation.sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA"

      - name: Run smoke checks
        run: |
          snow sql -f tests/sql/smoke_checks.sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA"

      - name: Run release verification calls
        run: |
          snow sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA" -q "CALL APP_CORE.sp_healthcheck();"
          snow sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA" -q "CALL APP_CORE.sp_export_diagnostics(24);"
          snow sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA" -q "CALL APP_CORE.sp_capture_migration_baseline();"
          snow sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA" -q "CALL APP_CORE.sp_upgrade_app();"
          snow sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA" -q "CALL APP_CORE.sp_validate_migration_integrity(NULL);"
          snow sql --connection OBSERVABILITYAPP --database "$TARGET_DB" --schema "$TARGET_SCHEMA" -q "CALL APP_ENGINE.sp_get_remediation_summary();"

      - name: Deployment summary
        run: |
          echo "Deployment completed for environment: $DEPLOY_ENV"
          echo "Target DB/Schema: $TARGET_DB.$TARGET_SCHEMA"
